<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.2">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon2.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon2.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon1.ico">
  <link rel="mask-icon" href="/images/favicon2.ico" color="#222">
  <link rel="manifest" href="/images/favicon2.ico">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.2/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"pandayuanyu.github.io","root":"/","images":"/images","scheme":"Muse","version":"8.2.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"livere","storage":true,"lazyload":false,"nav":null,"activeClass":"livere"},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/./public/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":-1,"unescape":false,"preload":false}};
  </script>
<meta name="description" content="Trajectory registration of IMU and USBL data, from WGS84 to ENU">
<meta property="og:type" content="article">
<meta property="og:title" content="trajectory registration of IMU and USBL data">
<meta property="og:url" content="https://pandayuanyu.github.io/2021/11/17/trajectory_registration/index.html">
<meta property="og:site_name" content="Yu Yuan&#39;s Space">
<meta property="og:description" content="Trajectory registration of IMU and USBL data, from WGS84 to ENU">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://i.bmp.ovh/imgs/2021/11/9032095f4213b9e2.jpg">
<meta property="og:image" content="https://i.bmp.ovh/imgs/2021/11/849d1aed42bb353a.png">
<meta property="og:image" content="https://i.bmp.ovh/imgs/2021/11/4fa1345969287866.png">
<meta property="og:image" content="https://i.bmp.ovh/imgs/2021/11/0cae621f66ec52aa.png">
<meta property="og:image" content="https://i.bmp.ovh/imgs/2021/11/d43c7cc0fd3cb1c2.png">
<meta property="og:image" content="https://i.bmp.ovh/imgs/2021/11/4da7c7ea6e10d948.png">
<meta property="article:published_time" content="2021-11-17T23:00:11.000Z">
<meta property="article:modified_time" content="2021-11-18T15:51:54.000Z">
<meta property="article:author" content="Yu Yuan">
<meta property="article:tag" content="配准">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.bmp.ovh/imgs/2021/11/9032095f4213b9e2.jpg">


<link rel="canonical" href="https://pandayuanyu.github.io/2021/11/17/trajectory_registration/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>
<title>trajectory registration of IMU and USBL data | Yu Yuan's Space</title>
  




  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Yu Yuan's Space</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags<span class="badge">12</span></a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories<span class="badge">9</span></a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives<span class="badge">22</span></a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#data-processing"><span class="nav-number">1.</span> <span class="nav-text">Data processing</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#imu-data-calculation-and-trajectory-drawing"><span class="nav-number">2.</span> <span class="nav-text">IMU data
calculation and trajectory drawing</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#usbl-data-calculation-and-trajectory-drawing"><span class="nav-number">3.</span> <span class="nav-text">USBL data
calculation and trajectory drawing</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#imu-and-usbl-data-registration"><span class="nav-number">4.</span> <span class="nav-text">IMU and USBL data
registration</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#trajectory-matching"><span class="nav-number">5.</span> <span class="nav-text">Trajectory matching</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#code"><span class="nav-number">6.</span> <span class="nav-text">Code</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Yu Yuan</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">22</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/pandayuanyu" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;pandayuanyu" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="/yuan418@purdue.edu" title="E-Mail → yuan418@purdue.edu"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://space.bilibili.com/93583902" title="Bilibili → https:&#x2F;&#x2F;space.bilibili.com&#x2F;93583902" rel="noopener" target="_blank"><i class="fa-brands fa-bilibili fa-fw"></i>Bilibili</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://pandayuanyu.github.io/2021/11/17/trajectory_registration/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Yu Yuan">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yu Yuan's Space">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          trajectory registration of IMU and USBL data
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-11-17 18:00:11" itemprop="dateCreated datePublished" datetime="2021-11-17T18:00:11-05:00">2021-11-17</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2021-11-18 10:51:54" itemprop="dateModified" datetime="2021-11-18T10:51:54-05:00">2021-11-18</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E4%B8%80%E4%BA%9B%E7%AE%97%E6%B3%95/" itemprop="url" rel="index"><span itemprop="name">一些算法</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="Symbols count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Symbols count in article: </span>
      <span>11k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>32 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <center>
Trajectory registration of IMU and USBL data, from WGS84 to ENU
</center>
<span id="more"></span>
<h2 id="data-processing">Data processing</h2>
<p>  Inertial navigationa data(IMU) is relatively continuous and
fluctuates less, which can be directly used for trajectory
transformation. Due to the influence of USBL equipment, USBL data has
many anomalies,such as large jump in time series, data not updated,
numerical anomaly and not continuous enough. Therefore, USBL data need
to be screened to eliminate outliers before they can be used for
trajectory description.<br />
  The USBL data screening scheme is as follows:<br />
  1. Delete the data that XYZ is 0 at the initial moment, during which
the USBL device does not normally send/receive valid data.<br />
  2. The X-axis of USBL points upward horizontally, which can be
understood as depth data. Since the relative variation range of depth
value is very small, data points with X value greater than 10 can be
deleted based on this standard.<br />
  3. The direction of the Y-axis of the USBL is roughly parallel to the
short edge of the experimental water area. With the USBL equipment as
the center, the range of the short edge of the experimental water area
is limited to ±50m.<br />
  4. Since the motion state of the object changes continuously and the
motion speed is relatively slow, the changes of data with similar time
stamps are generally monotonous and small, which can be used as the
standard to eliminate data points with large jumps.</p>
<p>  The following figure shows the track of unexcluded USBL abnormal
data. The green scatter points represent USBL data points, and the
existence of many abnormal points can be observed from the figure.</p>
<div data-align="center">
<img src="https://i.bmp.ovh/imgs/2021/11/9032095f4213b9e2.jpg" width="300"/>
</div>
<center>
Fig.1 Trajectory diagram without excluding USBL abnormal data
</center>
<p> </p>
<h2 id="imu-data-calculation-and-trajectory-drawing">IMU data
calculation and trajectory drawing</h2>
<p>  Since the IMU data initialization comes from GPS calibration, the
data values after IMU are also longitude and latitude values, and the
coordinate system is WGS84 geodetic coordinate system. In order to draw
the trajectory conveniently, the longitude and latitude values under
WGS84 need to be converted into the northeast Sky (ENU) coordinate
system with the origin of the first point measured by IMU. ENU
coordinate system is also called station center coordinate system. The
coordinate system takes the user's position as the origin, with X axis
pointing east, Y axis pointing north and Z axis pointing to the
zenith.<br />
  The transformation of data point coordinates from WGS84 to ENU
coordinate system consists of two steps:<br />
  1. Transfer the ENU coordinate system to the ECEF (Earth-centered
solid Right Angle) coordinate system</p>
<p>  The ORIGIN of the ECEF coordinate system is the earth's center of
mass, the X-axis extends through the intersection of the prime meridian
(0 degrees longitude) and the equator (0 degrees latitude), and the
Z-axis extends through the North Pole (that is, coincides with the
earth's rotation axis). The Y-axis follows the right-handed coordinate
system, crossing the equator and 90 degrees longitude. (Lon, Lat, Alt)
in the WGS84 coordinate system is converted to points (X,Y,Z) in the
ECEF coordinate system:</p>
<p><span class="math display">\[\left\{\begin{array}{l}X=(N+a l t) \cos
(l a t) \cos (l o n) \\ Y=(N+a l t) \cos (l a t) \sin (l o n) \\
Z=\left(N\left(1-e^{2}\right)+a l t\right) \sin (l a
t)\end{array}\right.\]</span></p>
<p>  Where e is the eccentricity of the ellipsoid and N is the radius of
curvature of the reference ellipsoid.</p>
<p><span
class="math display">\[\left\{\begin{array}{l}e^{2}=\frac{a^{2}-b^{2}}{a^{2}}
\\ N=\frac{a}{\sqrt{1-e^{2} \sin ^{2} l a
t}}\end{array}\right.\]</span></p>
<p>  Since polar flattening <span
class="math inline">\(f=\frac{a-b}{a}\)</span> under WGS-84, the
relationship between eccentricity e and polar flattening f is as
follows:</p>
<p><span class="math display">\[e^{2}=f(2-f)\]</span></p>
<p>  So N could also be written as</p>
<p><span class="math display">\[N=\frac{a}{\sqrt{1-f(2-f) \sin ^{2}
\operatorname{lat}}}\]</span></p>
<p>  2. Switch the ECEF coordinate system to the ENU coordinate
system</p>
<p>  The user's coordinate origin <span
class="math inline">\(P_{0}=\left(x_{0}, y_{0}, z_{0}\right)\)</span>,
calculate point <span class="math inline">\(P=(x, y, z)\)</span> at the
position of ENU coordinate system (e,n,u) with point <span
class="math inline">\(P_{0}\)</span> as the coordinate origin, the data
of WGS84 coordinate system are needed here, <span
class="math inline">\(L L A_{0}=\left(\right.\)</span> lon<span
class="math inline">\(_{0}\)</span>, lat<span
class="math inline">\(_{0}\)</span>, alt<span
class="math inline">\(\left._{0}\right)\)</span></p>
<p><span class="math display">\[\left[\begin{array}{l}\Delta x \\ \Delta
y \\ \Delta z\end{array}\right]=\left[\begin{array}{l}x \\ y \\
z\end{array}\right]-\left[\begin{array}{l}x_{0} \\ y_{0} \\
z_{0}\end{array}\right]\]</span></p>
<p><span class="math display">\[\left[\begin{array}{l}e \\ n \\
u\end{array}\right]=S \cdot\left[\begin{array}{l}\Delta x \\ \Delta y \\
\Delta z\end{array}\right]=\left[\begin{array}{ccc}-\sin
\left(\operatorname{lon}_{0}\right) &amp; \cos
\left(\operatorname{lon}_{0}\right) &amp; 0 \\ -\sin
\left(\operatorname{lat}_{0}\right) \cos
\left(\operatorname{lon}_{0}\right) &amp; -\sin
\left(\operatorname{lat}_{0}\right) \sin
\left(\operatorname{lon}_{0}\right) &amp; \cos
\left(\operatorname{lat}_{0}\right) \\ \cos
\left(\operatorname{lat}_{0}\right) \cos
\left(\operatorname{lon}_{0}\right) &amp; \cos
\left(\operatorname{lat}_{0}\right) \sin
\left(\operatorname{lon}_{0}\right) &amp; \sin
\left(\operatorname{lat}_{0}\right)\end{array}\right]
\cdot\left[\begin{array}{l}\Delta x \\ \Delta y \\ \Delta
z\end{array}\right]\]</span></p>
<p>  Namely, coordinate transformation matrix:</p>
<p><span class="math display">\[S=\left[\begin{array}{ccc}-\sin
\left(\operatorname{lon}_{0}\right) &amp; \cos
\left(\operatorname{lon}_{0}\right) &amp; 0 \\ -\sin
\left(\operatorname{lat}_{0}\right) \cos
\left(\operatorname{lon}_{0}\right) &amp; -\sin
\left(\operatorname{lat}_{0}\right) \sin
\left(\operatorname{lon}_{0}\right) &amp; \cos
\left(\operatorname{lat}_{0}\right) \\ \cos
\left(\operatorname{lat}_{0}\right) \cos
\left(\operatorname{lon}_{0}\right) &amp; \cos
\left(\operatorname{lat}_{0}\right) \sin
\left(\operatorname{lon}_{0}\right) &amp; \sin
\left(\operatorname{lat}_{0}\right)\end{array}\right]\]</span></p>
<p>  After all IMU data points have been converted to ENU coordinates,
the trajectory recorded by the IMU is plotted.</p>
<div data-align="center">
<img src="https://i.bmp.ovh/imgs/2021/11/849d1aed42bb353a.png" width="300"/>
</div>
<center>
Fig.2 Trajectory of IMU
</center>
<p> </p>
<h2 id="usbl-data-calculation-and-trajectory-drawing">USBL data
calculation and trajectory drawing</h2>
<p>  For the USBL data, the data took the USBL device as the origin and
the direction defined by the USBL device as the coordinate system. The
values were given. The Y-axis of the USBL coordinate system was closer
to the E-axis of ENU, and the Z-axis of the USBL coordinate system was
closer to the axis of ENU. The trajectory directly drawn is as
follows:</p>
<div data-align="center">
<img src="https://i.bmp.ovh/imgs/2021/11/4fa1345969287866.png" width="300"/>
</div>
<center>
Fig.3 Trajectories of IMU and USBL
</center>
<p>  It can be intuitively observed from the figure that due to the
Angle difference and position difference between USBL coordinate system
and ENU coordinate system, the trajectory angles of the two coordinate
systems differ by one Angle and their positions differ. Therefore, data
registration of the two coordinate systems is required.</p>
<p> </p>
<h2 id="imu-and-usbl-data-registration">IMU and USBL data
registration</h2>
<p>  Since there is an Angle difference between USBL and ENU coordinates
(e-n and Y-Z planes), we need to eliminate this Angle difference.
Because the Angle difference of the slope of the same line in different
coordinate systems on the same plane is equal to the Angle difference of
the coordinate axes. To calculate the Angle difference, A relatively
reliable data point A (the 225th timestamp data point) was selected to
calculate the coordinates of point A in ENU coordinate system (EN plane)
(-14.88295364,-35.75550466) and point A in USBL coordinate system (YZ
plane) (-38.0,-57.7). Then, according to the latitude and longitude
value of the USBL device coordinate point O, the coordinates of point O
in ENU coordinate system (13.16433724, 36.59235146) and the coordinates
of point O in USBL coordinate system (0,0) are calculated. After
obtaining the above four coordinates, the slope and Angle α of line OA
in ENU coordinate system and the slope and Angle β of line OA in USBL
coordinate system can be obtained, and then the Angle difference of the
two coordinate systems γ can be obtained:</p>
<p><span
class="math display">\[\gamma=\alpha-\beta=56.63194470^{\circ}-43.54190515^{\circ}=13.09003955^{\circ}\]</span></p>
<div data-align="center">
<img src="https://i.bmp.ovh/imgs/2021/11/0cae621f66ec52aa.png" width="300"/>
</div>
<center>
Fig.4 ENU coordinate and USBL coordinate
</center>
<p>  USBL data points can be registered into ENU coordinate system after
the Angle difference and position difference of the two coordinate axes
are known. The specific steps are as follows:<br />
1. Rotate the USBL coordinate system clockwise by the Angle γ The
rotation transformation formula of the coordinate axis is:</p>
<p><span class="math display">\[\left\{\begin{array}{l}x_{1}=x \cos
\theta+y \sin \theta \\ y_{1}=y \cos \theta-x \sin
\theta\end{array}\right.\]</span></p>
<ol start="2" type="1">
<li>Align the data coordinates obtained in Step 1 with the ENU
coordinate system</li>
</ol>
<p><span class="math display">\[\left\{\begin{array}{l}x_{2}=x_{1}+O_{E}
\\ y_{2}=y_{1}+O_{N}\end{array}\right.\]</span></p>
<p>  After obtaining the USBL data points after registration, the IMU
and USBL data tracks after registration are plotted.</p>
<div data-align="center">
<img src="https://i.bmp.ovh/imgs/2021/11/d43c7cc0fd3cb1c2.png" width="300"/>
</div>
<center>
Fig.5 IMU and USBL tracks after registration
</center>
<p> </p>
<h2 id="trajectory-matching">Trajectory matching</h2>
<p>  Using satellite photos and relevant GPS coordinates, the obtained
trajectory is superimposed with the actual field, and the following
results are obtained. The comparison between the figure and the actual
environment shows that the start point and the docking dock are
consistent with the actual situation, which proves the validity of data
processing and the authenticity of the trajectory from the side.</p>
<div data-align="center">
<img src="https://i.bmp.ovh/imgs/2021/11/4da7c7ea6e10d948.png" width="300"/>
</div>
<center>
Fig.6 Trajectory matching satellite image result
</center>
<p> </p>
<h2 id="code">Code</h2>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> math</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pymap3d <span class="keyword">as</span> pm</span><br><span class="line"><span class="keyword">import</span> xlrd                              <span class="comment">#xlrd==1.2.0</span></span><br><span class="line"><span class="keyword">from</span> matplotlib <span class="keyword">import</span> pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line"><span class="comment"># Location of USBL</span></span><br><span class="line">usbl_lonO = <span class="number">111.111111</span></span><br><span class="line">usbl_latO = <span class="number">88.188888889</span></span><br><span class="line">usbl_hO = -<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Read Excel data into matrix functions</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">excel2m</span>(<span class="params">path</span>):</span></span><br><span class="line">    data = xlrd.open_workbook(path)</span><br><span class="line">    table = data.sheets()[<span class="number">0</span>]             <span class="comment"># Get the first sheet in Excel</span></span><br><span class="line">    nrows = table.nrows</span><br><span class="line">    ncols = table.ncols</span><br><span class="line">    datamatrix = np.zeros((nrows, ncols))</span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(ncols):</span><br><span class="line">        cols = table.col_values(x)</span><br><span class="line">        cols1 = np.matrix(cols)           <span class="comment"># Convert list to matrix for matrix manipulation</span></span><br><span class="line">        datamatrix[:, x] = cols1          <span class="comment"># Store the data</span></span><br><span class="line">    <span class="keyword">return</span> datamatrix</span><br><span class="line"></span><br><span class="line">excel_imu = excel2m(<span class="string">&quot;C:\\Users\\imu.xlsx&quot;</span>)</span><br><span class="line">excel_usbl = excel2m(<span class="string">&quot;C:\\Users\\usbl1.xlsx&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># The local coordinate origin (original point of ENU)</span></span><br><span class="line">lat0 = <span class="number">111</span>             <span class="comment"># deg</span></span><br><span class="line">lon0 = <span class="number">88</span>             <span class="comment"># deg</span></span><br><span class="line">h0 = <span class="number">0</span>                         <span class="comment"># meters</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Convert imu(GPS) data into ENU coordinate</span></span><br><span class="line">lat = np.array(np.zeros((excel_imu.shape[<span class="number">0</span>],<span class="number">1</span>)))</span><br><span class="line">lon = np.array(np.zeros((excel_imu.shape[<span class="number">0</span>],<span class="number">1</span>)))</span><br><span class="line">h = np.array(np.zeros((excel_imu.shape[<span class="number">0</span>],<span class="number">1</span>)))</span><br><span class="line">e = []</span><br><span class="line">n = []</span><br><span class="line">u = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(excel_imu.shape[<span class="number">0</span>]):</span><br><span class="line">    lat[i] = excel_imu[i,<span class="number">1</span>]</span><br><span class="line">    lon[i] = excel_imu[i,<span class="number">0</span>]</span><br><span class="line">    h[i] = excel_imu[i,<span class="number">2</span>]</span><br><span class="line">    (xi,yi,zi) = pm.geodetic2enu(lat[i,<span class="number">0</span>], lon[i,<span class="number">0</span>], h[i,<span class="number">0</span>], lat0, lon0, h0)</span><br><span class="line">    e.append(xi)</span><br><span class="line">    n.append(yi)</span><br><span class="line">    u.append(zi)</span><br><span class="line"></span><br><span class="line">print(<span class="string">&#x27;e =&#x27;</span>,e)</span><br><span class="line">print(<span class="string">&#x27;n =&#x27;</span>,n)</span><br><span class="line">print(<span class="string">&#x27;u =&#x27;</span>,u)</span><br><span class="line"></span><br><span class="line"><span class="comment"># The coordinates of the USBL origin projected in the ENU coordinate system(point O)</span></span><br><span class="line">(usbl_eO,usbl_nO,usbl_uO) = pm.geodetic2enu(usbl_latO, usbl_lonO , usbl_hO, lat0, lon0, h0)</span><br><span class="line">print(<span class="string">&#x27;usbl_eO =&#x27;</span>,usbl_eO)</span><br><span class="line">print(<span class="string">&#x27;usbl_nO =&#x27;</span>,usbl_nO)</span><br><span class="line">print(<span class="string">&#x27;usbl_uO =&#x27;</span>,usbl_uO)</span><br><span class="line"></span><br><span class="line"><span class="comment"># choose one reliable point a of usbl(in USBL coordinate)</span></span><br><span class="line">usbl_a_y = excel_usbl[<span class="number">163</span>,<span class="number">1</span>] <span class="comment"># 163th does not match 225th as follows, because the same timestamp of point a in imu.xlsx and usbl.xlsx are not the same serial number</span></span><br><span class="line">usbl_a_z = excel_usbl[<span class="number">163</span>,<span class="number">2</span>]</span><br><span class="line">print(<span class="string">&#x27;usbl_a_y =&#x27;</span>,usbl_a_y)</span><br><span class="line">print(<span class="string">&#x27;usbl_a_z =&#x27;</span>,usbl_a_z)</span><br><span class="line"></span><br><span class="line"><span class="comment"># point a in ENU coordinate</span></span><br><span class="line">(enu_a_e,enu_a_n,enu_a_u) = pm.geodetic2enu(excel_imu[<span class="number">225</span>,<span class="number">1</span>], excel_imu[<span class="number">225</span>,<span class="number">0</span>], excel_imu[<span class="number">225</span>,<span class="number">2</span>], lat0, lon0, h0)</span><br><span class="line">print(<span class="string">&#x27;enu_a_e =&#x27;</span>,enu_a_e)</span><br><span class="line">print(<span class="string">&#x27;enu_a_n =&#x27;</span>,enu_a_n)</span><br><span class="line"></span><br><span class="line"><span class="comment"># The Angle difference of the same line in different plane coordinates is equal to the rotation Angle of the coordinate system</span></span><br><span class="line"><span class="comment"># Use the line Oa(point a is the origin of the USBL coordinate)</span></span><br><span class="line">k_enu = (enu_a_n - usbl_nO) / (enu_a_e - usbl_eO)         <span class="comment"># Slope of line Oa in ENU coordinate</span></span><br><span class="line">print(k_enu)</span><br><span class="line">angle_enu = math.atan(k_enu)                              <span class="comment"># Angle of line Oa in ENU(radian)</span></span><br><span class="line">print(angle_enu*<span class="number">180</span>/(math.pi))</span><br><span class="line">k_usbl = usbl_a_z / usbl_a_y                              <span class="comment"># Slope of line Oa in USBL coordinate</span></span><br><span class="line">print(k_usbl)</span><br><span class="line">angle_usbl = math.atan(k_usbl)                            <span class="comment"># Angle of line Oa in USBL(radian)</span></span><br><span class="line">print(angle_usbl*<span class="number">180</span>/(math.pi))</span><br><span class="line">angle_diff = angle_usbl - angle_enu</span><br><span class="line">print(<span class="string">&#x27;angle_diff =&#x27;</span>,angle_diff*<span class="number">180</span>/(math.pi))                          <span class="comment"># The rotation Angle value of two coordinate systems</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># registration process</span></span><br><span class="line">x = np.array(np.zeros((excel_usbl.shape[<span class="number">0</span>],<span class="number">1</span>)))</span><br><span class="line">y = np.array(np.zeros((excel_usbl.shape[<span class="number">0</span>],<span class="number">1</span>)))</span><br><span class="line">z = np.array(np.zeros((excel_usbl.shape[<span class="number">0</span>],<span class="number">1</span>)))</span><br><span class="line">usbl_x = []</span><br><span class="line">usbl_y = []</span><br><span class="line">usbl_z = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(excel_usbl.shape[<span class="number">0</span>]):</span><br><span class="line">    x[i,<span class="number">0</span>] = excel_usbl[i,<span class="number">0</span>]</span><br><span class="line">    <span class="comment"># y[i, 0] = excel_usbl[i, 1]</span></span><br><span class="line">    <span class="comment"># z[i, 0] = excel_usbl[i, 2]</span></span><br><span class="line">    y[i,<span class="number">0</span>] = excel_usbl[i,<span class="number">1</span>] * math.cos(angle_diff) + excel_usbl[i,<span class="number">2</span>] * math.sin(angle_diff) + usbl_eO</span><br><span class="line">    z[i,<span class="number">0</span>] = excel_usbl[i,<span class="number">2</span>] * math.cos(angle_diff) - excel_usbl[i,<span class="number">1</span>] * math.sin(angle_diff) + usbl_nO + <span class="number">6</span></span><br><span class="line">    usbl_x.append(x[i,<span class="number">0</span>])</span><br><span class="line">    usbl_y.append(y[i,<span class="number">0</span>])</span><br><span class="line">    usbl_z.append(z[i,<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">print(<span class="string">&#x27;usbl_x =&#x27;</span>,usbl_x)</span><br><span class="line">print(<span class="string">&#x27;usbl_y =&#x27;</span>,usbl_y)</span><br><span class="line">print(<span class="string">&#x27;usbl_z =&#x27;</span>,usbl_z)</span><br><span class="line"></span><br><span class="line">fig = plt.figure()</span><br><span class="line">fig = plt.plot(e,n)</span><br><span class="line">plt.scatter(usbl_y,usbl_z,c=<span class="string">&#x27;r&#x27;</span>,s=<span class="number">5</span>)</span><br><span class="line">plt.xlabel(<span class="string">&#x27;East(m)&#x27;</span>)</span><br><span class="line">plt.ylabel(<span class="string">&#x27;North(m)&#x27;</span>)</span><br><span class="line">plt.title(<span class="string">&#x27;IMU and USBL trajectories in ENU coordinate&#x27;</span>,size=<span class="number">16</span>,loc = <span class="string">&#x27;center&#x27;</span>)</span><br><span class="line">plt.legend([<span class="string">&#x27;IMU&#x27;</span>,<span class="string">&#x27;USBL&#x27;</span>])</span><br><span class="line">plt.axis(<span class="string">&#x27;equal&#x27;</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E9%85%8D%E5%87%86/" rel="tag"># 配准</a>
          </div>

        
  <div class="post-widgets">
    <div class="wp_rating">
      <div id="wpac-rating"></div>
    </div>
  </div>

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2021/11/01/openvino_yolov5/" rel="prev" title="Deploy yolov5 with OpenVINO">
                  <i class="fa fa-chevron-left"></i> Deploy yolov5 with OpenVINO
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2021/12/01/vision_stereo/" rel="next" title="Stereo Vision">
                  Stereo Vision <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments" id="lv-container" data-id="city" data-uid="MTAyMC81MzEwMS8yOTU3Nw=="></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Yu Yuan</span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>


    <script async src=“https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js”></script>


    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>

  
  <script>
  if (CONFIG.page.isPost) {
    wpac_init = window.wpac_init || [];
    wpac_init.push({
      widget: 'Rating',
      id    : ,
      el    : 'wpac-rating',
      color : '#fc6423'
    });
    (function() {
      if ('WIDGETPACK_LOADED' in window) return;
      WIDGETPACK_LOADED = true;
      var mc = document.createElement('script');
      mc.type = 'text/javascript';
      mc.async = true;
      mc.src = '//embed.widgetpack.com/widget.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(mc, s.nextSibling);
    })();
  }
  </script>
<script src="/js/local-search.js"></script>



<script>
if (document.querySelectorAll('.pdf-container').length) {
  NexT.utils.getScript('https://cdn.jsdelivr.net/npm/pdfobject@2.2.4/pdfobject.min.js', () => {
    document.querySelectorAll('.pdf-container').forEach(element => {
      PDFObject.embed(element.dataset.target, element, {
        pdfOpenParams: {
          navpanes : 0,
          toolbar  : 0,
          statusbar: 0,
          pagemode : 'thumbs',
          view     : 'FitH'
        },
        PDFJS_URL: '/lib/pdf/web/viewer.html',
        height   : element.dataset.height
      });
    });
  }, window.PDFObject);
}
</script>



  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  <script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'all'
      },
      options: {
        renderActions: {
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              const target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3.1.2/es5/tex-mml-chtml.js';
    script.defer = true;
    document.head.appendChild(script);
  } else {
    MathJax.startup.document.state(0);
    MathJax.typesetClear();
    MathJax.texReset();
    MathJax.typeset();
  }
</script>



<script>
NexT.utils.loadComments('#lv-container', () => {
  window.livereOptions = {
    refer: "2021/11/17/trajectory_registration/"
  };
  (function(d, s) {
    var j, e = d.getElementsByTagName(s)[0];
    if (typeof LivereTower === 'function') { return; }
    j = d.createElement(s);
    j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
    j.async = true;
    e.parentNode.insertBefore(j, e);
  })(document, 'script');
});
</script>

</body>
</html>


<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/boom.js"></script>
